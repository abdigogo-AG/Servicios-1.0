<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Mi Panel - Servicios del Hogar</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="principal.css">
    <style>
        body { background-color: #f4f6f8; align-items: flex-start; }
        
        header {
            background: white; padding: 15px 5%; display: flex; justify-content: space-between; 
            align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); width: 100%; position: sticky; top: 0; z-index: 100;
        }
        
        .container-dashboard { max-width: 1000px; margin: 40px auto; padding: 0 20px; width: 100%; }

        .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .btn-accion { background-color: #0b69ff; color: white; padding: 10px 20px; border-radius: 5px; text-decoration: none; font-weight: bold; display: inline-flex; gap: 8px; border: none; cursor: pointer; }
        .btn-accion:hover { background-color: #0056d6; transform: translateY(-2px); }
        .btn-logout { border: 1px solid #dc3545; color: #dc3545; background: white; padding: 5px 15px; border-radius: 20px; cursor: pointer; font-weight: bold; }

        /* GRID SERVICIOS */
        .grid-servicios { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        .servicio-card { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border-left: 5px solid #ccc; transition: 0.2s; }
        .servicio-card:hover { transform: translateY(-3px); }

        /* ESTADOS */
        .borde-SOLICITADO { border-left-color: #ffc107; }
        .borde-ACEPTADO, .borde-EN_PROCESO { border-left-color: #28a745; }
        .borde-TERMINADO { border-left-color: #17a2b8; background-color: #f0f8fb; opacity: 0.9; }

        /* DETALLES TRABAJADOR (MODAL) */
        .worker-profile-card { display: flex; gap: 15px; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px; }
        .worker-avatar { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid #eee; }
        .worker-details h4 { margin: 0 0 5px; font-size: 16px; }
        .worker-bio { font-size: 12px; color: #666; margin: 5px 0; font-style: italic; }
        .worker-stats { display: flex; gap: 10px; font-size: 12px; }
        .rating-stars { color: #ffc107; }

        /* Bot√≥n WhatsApp (Solo visible tras pago) */
        .btn-whatsapp { background: #25D366; color: white; padding: 8px 15px; border-radius: 20px; text-decoration: none; font-weight: bold; display: inline-flex; align-items: center; gap: 5px; font-size: 14px; margin-top: 10px; }
        .btn-whatsapp:hover { background: #1ebc57; }
    </style>
</head>
<body>

    <header>
        <div class="logo" style="font-weight: bold; color: #0b69ff; font-size: 22px; cursor:pointer;" onclick="window.location.href='index.html'">
            <i class="fas fa-home"></i> ServiciosApp
        </div>
        <div style="display: flex; align-items: center; gap: 15px;">
            <span id="user-name" style="color: #555; font-weight: 500;">...</span>
            <button id="btn-mi-perfil" class="btn-accion" style="background: #6c757d; padding: 5px 15px; font-size: 14px;">
                <i class="fas fa-user"></i> Perfil
            </button>
            <button onclick="cerrarSesion()" class="btn-logout"><i class="fas fa-sign-out-alt"></i></button>
        </div>
    </header>

    <div class="container-dashboard">
        <div class="dashboard-header">
            <h1 id="titulo-dashboard">Mis Actividades</h1>
            <a id="btn-principal-accion" href="#" class="btn-accion"><i class="fas fa-plus"></i> Acci√≥n</a>
        </div>

        <div id="lista-servicios" class="grid-servicios">
            <p>Cargando informaci√≥n...</p>
        </div>
    </div>

    <script>
        const API_URL = "http://localhost:8080";
        const usuarioId = localStorage.getItem("usuario_id");
        const usuarioNombre = localStorage.getItem("usuario_nombre");
        const esTrabajador = localStorage.getItem("es_trabajador") === "true"; 

        if (!usuarioId) window.location.href = "login.html";

        document.getElementById('user-name').innerText = "Hola, " + (usuarioNombre ? usuarioNombre.split(" ")[0] : "Usuario");
        
        const btnPerfil = document.getElementById('btn-mi-perfil');
        btnPerfil.onclick = () => {
            window.location.href = esTrabajador ? "perfil_trabajador.html" : "perfil_cliente.html";
        };

        const titulo = document.getElementById('titulo-dashboard');
        const btnAccion = document.getElementById('btn-principal-accion');
        const contenedor = document.getElementById('lista-servicios');

        async function cargarDashboard() {
            // 1. VERIFICAR SI VENIMOS DE UN PAGO DE STRIPE
            const urlParams = new URLSearchParams(window.location.search);
            const statusPago = urlParams.get('status'); // 'approved', 'failure'
            const sessionId = urlParams.get('session'); // ID de la sesi√≥n de Stripe
            
            console.log("üîç Dashboard cargado - Verificando pago...");
            console.log("  status:", statusPago);
            console.log("  session:", sessionId);
            
            if (statusPago === 'approved' && sessionId) {
                console.log("‚úÖ Detectado retorno de Stripe con pago aprobado");
                
                // Validar el pago con el backend
                try {
                    console.log(`üîó Validando sesi√≥n en backend: ${API_URL}/pagos/validar-sesion/${sessionId}`);
                    const validacionRes = await fetch(`${API_URL}/pagos/validar-sesion/${sessionId}`);
                    const validacion = await validacionRes.json();
                    
                    console.log("üìä Respuesta de validaci√≥n:", validacion);
                    
                    if (validacion.status === 'approved') {
                        console.log("‚úÖ Pago validado como COMPLETADO");
                        // Limpiamos la URL primero
                        window.history.replaceState({}, document.title, "dashboard.html");
                        
                        Swal.fire({
                            title: "¬°Pago Recibido! ‚úÖ",
                            text: "Has contratado al trabajador correctamente. Ahora puedes ver su contacto.",
                            icon: "success",
                            didClose: () => {
                                console.log("üîÑ Recargando p√°gina...");
                                location.reload();
                            }
                        });
                        return;
                    } else if (validacion.status === 'pending') {
                        console.log("‚è≥ Pago a√∫n pendiente");
                        window.history.replaceState({}, document.title, "dashboard.html");
                        Swal.fire({
                            title: "Pago Pendiente ‚è≥",
                            text: validacion.mensaje || "El pago a√∫n est√° siendo procesado. Por favor espera...",
                            icon: "info",
                            allowOutsideClick: false
                        });
                    } else {
                        console.log("‚ùå Estado desconocido:", validacion.status);
                        window.history.replaceState({}, document.title, "dashboard.html");
                        Swal.fire({
                            title: "Estado Desconocido",
                            text: validacion.mensaje || "No se pudo determinar el estado del pago.",
                            icon: "warning"
                        });
                    }
                } catch (error) {
                    console.error("‚ùå Error validando sesi√≥n:", error);
                    window.history.replaceState({}, document.title, "dashboard.html");
                    Swal.fire("Error", "No se pudo validar el pago con el servidor.", "error");
                }
            } else if (statusPago === 'failure') {
                console.log("‚ùå Pago cancelado o fallido");
                window.history.replaceState({}, document.title, "dashboard.html");
                Swal.fire("Pago Cancelado ‚ùå", "No completaste el pago. Intenta de nuevo.", "error");
            }

            let url = "";
            if (esTrabajador) {
                titulo.innerText = "Mis Trabajos Activos";
                btnAccion.innerHTML = `<i class="fas fa-search"></i> Buscar Nuevos Trabajos`;
                btnAccion.href = "ver_trabajos.html"; 
                btnAccion.style.background = "#28a745";
                url = `${API_URL}/trabajador/mis-trabajos/${usuarioId}`;
            } else {
                titulo.innerText = "Mis Solicitudes";
                btnAccion.innerHTML = `<i class="fas fa-paper-plane"></i> Pedir Nuevo Servicio`;
                btnAccion.href = "solicitar.html";
                url = `${API_URL}/servicios/${usuarioId}`;
            }

            try {
                const res = await fetch(url);
                const datos = await res.json();
                contenedor.innerHTML = ""; 

                if (datos.length === 0) {
                    contenedor.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:40px; background:white; border-radius:10px;">
                        <i class="fas fa-inbox" style="font-size:40px; color:#ccc;"></i><p>No hay actividad a√∫n.</p>
                    </div>`;
                    return;
                }

                datos.forEach(s => {
                    const fecha = new Date(s.fecha_programada || s.fecha_solicitud).toLocaleDateString();
                    const precio = s.precio_estimado > 0 ? `$${s.precio_estimado}` : "A convenir";
                    
                    // --- INFORMACI√ìN DEL TRABAJADOR (Despu√©s de pago) ---
                    let infoTrabajadorHTML = "";
                    if ((s.estado === 'EN_PROCESO' || s.estado === 'TERMINADO') && s.trabajador_nombre) {
                        // Generar estrellas
                        let estrellas = "";
                        if (s.trabajador_calificacion && s.trabajador_calificacion > 0) {
                            const rating = Math.round(s.trabajador_calificacion);
                            estrellas = "‚≠ê".repeat(rating);
                        } else {
                            estrellas = "Cuenta Nueva";
                        }
                        
                        infoTrabajadorHTML = `
                            <div style="background:#f9f9f9; padding:15px; border-radius:8px; margin:10px 0; border:1px solid #e0e0e0;">
                                <div style="display:flex; gap:15px; align-items:flex-start;">
                                    <div style="flex:1;">
                                        <h4 style="margin:0 0 5px; color:#333;">${s.trabajador_nombre}</h4>
                                        <div style="color:#f39c12; font-size:14px; margin-bottom:5px;">${estrellas}</div>
                                        <small style="color:#666; display:block; margin-bottom:8px;"><i class="fas fa-briefcase"></i> ${s.categoria}</small>
                                        <p style="margin:8px 0; color:#555; font-size:13px;">${s.trabajador_bio || 'Sin descripci√≥n'}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    // --- INFORMACI√ìN DEL CLIENTE (Para trabajador) ---
                    let infoClienteHTML = "";
                    if ((s.estado === 'EN_PROCESO' || s.estado === 'TERMINADO') && esTrabajador) {
                        infoClienteHTML = `
                            <div style="background:#f0f8ff; padding:15px; border-radius:8px; margin:10px 0; border:1px solid #b3d9ff;">
                                <h4 style="margin:0 0 10px; color:#0066cc;"><i class="fas fa-user"></i> Cliente</h4>
                                <small style="color:#666; display:block;"><i class="fas fa-map-marker-alt"></i> ${s.direccion_texto}</small>
                            </div>
                        `;
                    }
                    
                    // --- L√ìGICA DE CONTACTO (Solo si ya se pag√≥/acept√≥) ---
                    let contactoHTML = "";
                    if ((s.estado === 'ACEPTADO' || s.estado === 'EN_PROCESO' || s.estado === 'TERMINADO')) {
                        // Si eres cliente, mostrar tel√©fono del trabajador
                        if (!esTrabajador && s.trabajador_telefono) {
                            const waNumber = s.trabajador_telefono.replace(/\D/g, '');
                            contactoHTML = `
                                <div style="background:#e8f5e9; padding:10px; border-radius:8px; margin:10px 0; border-left:4px solid #28a745;">
                                    <small style="color:#666;">üìû Tel√©fono del trabajador:</small><br>
                                    <strong style="color:#28a745; font-size:16px;">${s.trabajador_telefono}</strong>
                                    <a href="https://wa.me/52${waNumber}" target="_blank" class="btn-whatsapp" style="margin-top:8px;">
                                        <i class="fab fa-whatsapp"></i> Contactar por WhatsApp
                                    </a>
                                </div>
                            `;
                        } else if (esTrabajador && s.cliente_telefono) {
                            // Si eres trabajador, mostrar tel√©fono del cliente
                            const waNumber = s.cliente_telefono.replace(/\D/g, '');
                            contactoHTML = `
                                <div style="background:#e3f2fd; padding:10px; border-radius:8px; margin:10px 0; border-left:4px solid #2196F3;">
                                    <small style="color:#666;">üìû Tel√©fono del cliente:</small><br>
                                    <strong style="color:#2196F3; font-size:16px;">${s.cliente_telefono}</strong>
                                    <a href="https://wa.me/52${waNumber}" target="_blank" class="btn-whatsapp" style="margin-top:8px; background:#2196F3;">
                                        <i class="fab fa-whatsapp"></i> Contactar por WhatsApp
                                    </a>
                                </div>
                            `;
                        }
                    }

                    // --- BOTONES DE ACCI√ìN ---
                    let accionesHTML = "";
                    if (!esTrabajador) { 
                        // VISTA CLIENTE
                        if (s.estado === 'SOLICITADO') {
                            const num = s.num_propuestas || 0;
                            accionesHTML = num > 0 
                                ? `<button onclick="verPropuestas('${s.id}')" class="btn-accion" style="background:#6f42c1; font-size:12px; width:100%; justify-content:center;">Ver ${num} Propuestas</button>`
                                : `<small style="color:#777">Esperando postulaciones...</small>`;
                        } else if (s.estado === 'EN_PROCESO') {
                            accionesHTML = `<button onclick="completarServicio('${s.id}')" class="btn-accion" style="background:#28a745; font-size:12px; width:100%; justify-content:center;"><i class="fas fa-check"></i> Servicio Completado</button>`;
                        } else if (s.estado === 'TERMINADO') {
                            accionesHTML = `<small style="color:#17a2b8; font-weight:bold;"><i class="fas fa-check-double"></i> Servicio Completado</small>`;
                        }
                    } else {
                        // VISTA TRABAJADOR
                        let estadoColor = "#ccc";
                        if (s.estado === 'EN_PROCESO') estadoColor = "#28a745";
                        if (s.estado === 'TERMINADO') estadoColor = "#17a2b8";
                        
                        accionesHTML = `<small style="color:${estadoColor}; font-weight:bold;"><i class="fas fa-briefcase"></i> ${s.estado}</small>`;
                    }

                    const html = `
                        <div class="servicio-card borde-${s.estado}">
                            <div class="card-header">
                                <span class="card-tag">${s.categoria || 'Servicio'}</span>
                                <span class="precio">${precio}</span>
                            </div>
                            <h3 class="card-title">${s.titulo}</h3>
                            <p class="card-desc">${s.descripcion}</p>
                            
                            <div style="margin:10px 0; font-size:13px; color:#888; border-top:1px solid #eee; padding-top:10px;">
                                <i class="far fa-calendar-alt"></i> ${fecha} <br>
                                <i class="fas fa-map-marker-alt"></i> ${s.direccion_texto || 'Ubicaci√≥n mapa'}
                            </div>

                            ${infoTrabajadorHTML}
                            ${infoClienteHTML}
                            ${contactoHTML}
                            <div style="margin-top:10px;">${accionesHTML}</div>
                        </div>
                    `;
                    contenedor.innerHTML += html;
                });
            } catch (error) { console.error(error); }
        }

        // --- VER PROPUESTAS (SIN TEL√âFONO) ---
        async function verPropuestas(id) {
            try {
                // Primero, comprobar el estado del servicio para evitar ver propuestas si ya fue contratado
                const svcRes = await fetch(`${API_URL}/servicio/${id}`);
                if (!svcRes.ok) {
                    console.error('No se pudo obtener el servicio para verificar estado');
                } else {
                    const svc = await svcRes.json();
                    if (svc.estado && svc.estado !== 'SOLICITADO') {
                        // Mostrar informaci√≥n del trabajador (ya asignado)
                        const mensaje = `Estado: ${svc.estado}\n\n` +
                            (svc.trabajador_nombre ? `Trabajador: ${svc.trabajador_nombre}\n` : '') +
                            (svc.trabajador_bio ? `\n${svc.trabajador_bio}\n` : '') +
                            (svc.trabajador_telefono ? `\nTel: ${svc.trabajador_telefono}` : '');
                        return Swal.fire('Informaci√≥n', mensaje, 'info');
                    }
                }

                const res = await fetch(`${API_URL}/servicios/${id}/propuestas`);
                const props = await res.json();

                if(props.length === 0) return Swal.fire("A√∫n no hay propuestas");

                let htmlLista = "";
                props.forEach(p => {
                    const rating = p.calificacion_promedio ? `‚≠ê ${p.calificacion_promedio}` : '‚ú® Nuevo';
                    const exp = p.anios_experiencia ? `(${p.anios_experiencia} a√±os exp)` : "";
                    
                    htmlLista += `
                        <div class="worker-profile-card">
                            <img src="${p.foto_perfil_url || 'https://via.placeholder.com/60'}" class="worker-avatar" onerror="this.src='https://via.placeholder.com/60'">
                            <div class="worker-details" style="text-align:left; flex:1;">
                                <h4>${p.nombre} ${p.apellidos || ''}</h4>
                                <div class="worker-stats" style="color:#f39c12;">${rating} <span style="color:#777;">${exp}</span></div>
                                <p class="worker-bio">"${p.mensaje}"</p>
                                <div style="font-weight:bold; color:#28a745; margin-top:5px;">Oferta: $${p.precio_oferta}</div>
                                <small style="color:#999; font-size:10px;">* Contacto disponible tras contratar</small>
                            </div>
                            <button class="btn-accion" style="height:fit-content; font-size:12px; background:#009ee3;" onclick="iniciarPagoReal('${id}', '${p.trabajador_id}', '${p.id}', ${p.precio_oferta})">
                                Pagar y Contratar
                            </button>
                        </div>
                    `;
                });

                Swal.fire({
                    title: 'Propuestas Recibidas',
                    html: `<div style="max-height:400px; overflow-y:auto; text-align:left;">${htmlLista}</div>`,
                    width: 600,
                    showConfirmButton: false, 
                    showCloseButton: true
                });

            } catch(e) { 
                console.error(e); 
                Swal.fire("Error", "No se cargaron las propuestas", "error"); 
            }
        }

        // --- PAGO REAL CON STRIPE ---
        async function iniciarPagoReal(servicioId, trabajadorId, propuestaId, monto) {
            console.log("üí≥ Iniciando pago...");
            console.log("  servicioId:", servicioId);
            console.log("  trabajadorId:", trabajadorId);
            console.log("  propuestaId:", propuestaId);
            console.log("  monto:", monto);
            
            Swal.close(); // Cerrar lista

            Swal.fire({
                title: 'Generando pago...',
                text: 'Te estamos redirigiendo a Stripe para asegurar tu dinero.',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });

            try {
                // 1. Llamamos al endpoint correcto del backend
                console.log(`üîó Enviando solicitud a: ${API_URL}/pagos/crear-preferencia`);
                const res = await fetch(`${API_URL}/pagos/crear-preferencia`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        servicio_id: servicioId,
                        titulo: "Contrataci√≥n de Servicio",
                        precio: parseFloat(monto),
                        trabajador_id: trabajadorId,
                        propuesta_id: propuestaId
                    })
                });

                console.log("üìä Respuesta del servidor - Status:", res.status);

                let data = null;
                try {
                    data = await res.json();
                    console.log("üìã Datos recibidos:", data);
                } catch (errJson) {
                    console.error("‚ùå Error parseando JSON:", errJson);
                    Swal.fire("Error", "El servidor no respondi√≥ correctamente", "error");
                    return;
                }

                if (!res.ok) {
                    const servidorMsg = data && (data.detail || data.error || data.message) ? (data.detail || data.error || data.message) : `Error del servidor (${res.status})`;
                    console.error("‚ùå Error del servidor:", servidorMsg);
                    Swal.fire("Error", servidorMsg, "error");
                    return;
                }

                if (data && data.init_point) {
                    console.log("‚úÖ URL de Stripe recibida:", data.init_point);
                    console.log("üîó Redirigiendo a Stripe...");
                    // 2. ¬°REDIRECCI√ìN REAL! Nos vamos a la p√°gina de Stripe
                    window.location.href = data.init_point;
                } else {
                    console.error("‚ùå No se recibi√≥ init_point en la respuesta");
                    Swal.fire("Error", "No se pudo generar el link de pago", "error");
                }

            } catch (e) {
                console.error("‚ùå Error en iniciarPagoReal:", e);
                Swal.fire("Error", "Fallo de conexi√≥n con el servidor: " + e.message, "error");
            }
        }

        async function finalizarServicio(id) {
            const { value: formValues } = await Swal.fire({
                title: 'Calificar Servicio',
                html: '<input id="swal-input1" class="swal2-input" type="number" min="1" max="5" placeholder="Estrellas (1-5)"><textarea id="swal-input2" class="swal2-textarea" placeholder="Rese√±a..."></textarea>',
                focusConfirm: false,
                preConfirm: () => { return { calificacion: document.getElementById('swal-input1').value, resena: document.getElementById('swal-input2').value } }
            });
            if (formValues) {
                try {
                    const res = await fetch(`${API_URL}/servicios/finalizar`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ servicio_id: id, calificacion: parseInt(formValues.calificacion), resena: formValues.resena })
                    });
                    if(res.ok) { Swal.fire("¬°Gracias!", "Servicio finalizado.", "success"); cargarDashboard(); }
                } catch(e) { console.error(e); }
            }
        }

        async function completarServicio(servicioId) {
            console.log("‚úÖ Cliente confirma servicio completado:", servicioId);
            
            // Primero confirmar que est√° completo
            const { isConfirmed } = await Swal.fire({
                title: '¬øServicio Completado?',
                text: 'Confirma que el trabajo ha sido realizado correctamente.',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'S√≠, est√° completo',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#dc3545'
            });

            if (!isConfirmed) return;

            // Segundo: Abrir formulario de calificaci√≥n
            const { value: calificacionData } = await Swal.fire({
                title: 'Calificar al Trabajador',
                html: `
                    <div style="text-align: center; padding: 20px;">
                        <div style="margin-bottom: 30px;">
                            <label style="display: block; margin-bottom: 15px; font-weight: bold; color: #333;">¬øC√≥mo fue el servicio?</label>
                            <div id="rating-stars" style="font-size: 40px; letter-spacing: 10px; cursor: pointer;">
                                <span class="star" data-value="1" style="cursor: pointer; color: #ddd; transition: color 0.2s;">‚òÖ</span>
                                <span class="star" data-value="2" style="cursor: pointer; color: #ddd; transition: color 0.2s;">‚òÖ</span>
                                <span class="star" data-value="3" style="cursor: pointer; color: #ddd; transition: color 0.2s;">‚òÖ</span>
                                <span class="star" data-value="4" style="cursor: pointer; color: #ddd; transition: color 0.2s;">‚òÖ</span>
                                <span class="star" data-value="5" style="cursor: pointer; color: #ddd; transition: color 0.2s;">‚òÖ</span>
                            </div>
                            <input type="hidden" id="rating-value" value="0">
                            <p id="rating-text" style="margin-top: 10px; color: #999; font-size: 14px;">Selecciona una calificaci√≥n</p>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 10px; font-weight: bold; color: #333;">Deja una rese√±a (opcional)</label>
                            <textarea id="resena-text" class="swal2-textarea" placeholder="Cu√©ntanos tu experiencia con el trabajador..." style="min-height: 100px; resize: vertical;"></textarea>
                        </div>
                    </div>
                `,
                didOpen: () => {
                    // Configurar las estrellas para ser interactivas
                    const stars = document.querySelectorAll('.star');
                    const ratingValue = document.getElementById('rating-value');
                    const ratingText = document.getElementById('rating-text');
                    
                    const textos = ["", "Muy malo", "Malo", "Normal", "Bueno", "Excelente"];
                    
                    stars.forEach(star => {
                        star.addEventListener('click', () => {
                            const value = parseInt(star.dataset.value);
                            ratingValue.value = value;
                            
                            // Cambiar color de las estrellas
                            stars.forEach(s => {
                                if (parseInt(s.dataset.value) <= value) {
                                    s.style.color = '#ffc107';
                                } else {
                                    s.style.color = '#ddd';
                                }
                            });
                            
                            ratingText.textContent = textos[value];
                        });
                        
                        // Efecto hover
                        star.addEventListener('mouseover', () => {
                            const value = parseInt(star.dataset.value);
                            stars.forEach(s => {
                                if (parseInt(s.dataset.value) <= value) {
                                    s.style.color = '#ffb300';
                                } else {
                                    s.style.color = '#ddd';
                                }
                            });
                        });
                    });
                    
                    document.getElementById('rating-stars').addEventListener('mouseout', () => {
                        const value = parseInt(ratingValue.value);
                        stars.forEach(s => {
                            if (parseInt(s.dataset.value) <= value) {
                                s.style.color = '#ffc107';
                            } else {
                                s.style.color = '#ddd';
                            }
                        });
                    });
                },
                showCancelButton: true,
                confirmButtonText: 'Guardar Calificaci√≥n',
                cancelButtonText: 'Cancelar',
                preConfirm: () => {
                    const calificacion = document.getElementById('rating-value').value;
                    const resena = document.getElementById('resena-text').value;
                    
                    if (calificacion === '0') {
                        Swal.showValidationMessage('Por favor selecciona una calificaci√≥n');
                        return false;
                    }
                    
                    return {
                        calificacion: parseInt(calificacion),
                        resena: resena.trim()
                    };
                }
            });

            if (!calificacionData) return; // Usuario cancel√≥

            // Tercero: Enviar datos al servidor
            Swal.fire({
                title: 'Guardando calificaci√≥n...',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });

            try {
                const res = await fetch(`${API_URL}/servicios/${servicioId}/completar`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        calificacion: calificacionData.calificacion,
                        resena: calificacionData.resena
                    })
                });

                if (res.ok) {
                    Swal.fire({
                        title: '¬°Gracias por tu calificaci√≥n! ‚≠ê',
                        html: `
                            <p>El servicio ha sido marcado como completado.</p>
                            <p style="font-size: 24px; color: #ffc107; margin: 20px 0;">
                                ${'‚òÖ'.repeat(calificacionData.calificacion)}${'‚òÜ'.repeat(5 - calificacionData.calificacion)}
                            </p>
                            <p style="color: #666; font-size: 14px;">${calificacionData.resena || 'Sin comentarios adicionales'}</p>
                        `,
                        icon: 'success',
                        didClose: () => {
                            cargarDashboard();
                        }
                    });
                } else {
                    const error = await res.json();
                    Swal.fire('Error', error.detail || 'No se pudo completar el servicio', 'error');
                }
            } catch (e) {
                console.error("‚ùå Error completando servicio:", e);
                Swal.fire('Error', 'Fallo de conexi√≥n: ' + e.message, 'error');
            }
        }

        function cerrarSesion() {
            if(confirm("¬øCerrar sesi√≥n?")) { localStorage.clear(); window.location.href = "login.html"; }
        }

        cargarDashboard();
    </script>
</body>
</html>